<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Student Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --primary:#5b3cc4;
      --primary-dark:#4a2db1;
      --accent:#00c389;
      --bg:#f6f7fb;
    }
    body { min-height:100vh; background:var(--bg); }
    .app-shell{ display:flex; }
    .sidebar{ width:240px; background:linear-gradient(180deg, var(--primary), var(--primary-dark)); color:#fff; }
    .sidebar a{ color:#fff; text-decoration:none; border-radius:10px; padding:10px 12px; display:block; }
    .sidebar a:hover{ background:rgba(255,255,255,.12); }
    .brand{ font-weight:700; letter-spacing:.3px; }
    .content{ margin-left:260px; padding:24px; }
    .section-card{ background:#fff; border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,.05); padding:16px; }
    .table-sm th, .table-sm td { vertical-align:middle; }
    .timer { font-weight:bold; color:#e55353; }
    .btn-rounded{ border-radius:10px; }
    .list-badge{ padding:6px 10px; border-radius:10px; font-size:12px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-light bg-white shadow-sm">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1 brand">Student Dashboard</span>
      <div>
        <a href="/student/logout" class="btn btn-outline-secondary">Logout</a>
      </div>
    </div>
  </nav>

  <div class="app-shell">
    <!-- Sidebar -->
    <div class="sidebar vh-100 p-3 position-fixed">
      <div class="d-flex align-items-center gap-2 mb-3">
        <div class="rounded-circle bg-white text-dark d-flex align-items-center justify-content-center" style="width:34px;height:34px;font-weight:700;">S</div>
        <div class="fw-semibold">TCOMP</div>
      </div>
      <div class="small text-white-50 mb-2">Menu</div>
      <ul class="list-unstyled d-grid gap-1">
        <li><a href="#" onclick="showExams()">ðŸ“‹ Available Exams</a></li>
        <li><a href="#" onclick="showMyMarks()">ðŸ“ˆ My Marks</a></li>
      </ul>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- Available Exams -->
      <div id="panel-exams" class="section-card">
        <h4 class="mb-3">Available Exams</h4>
        <div id="exams-list">Loading...</div>
      </div>

      <!-- Question Paper -->
      <div id="panel-exam" class="section-card" style="display:none;">
        <h4 id="exam-title" class="mb-2"></h4>
        <div class="mb-2">Time Left: <span id="exam-timer" class="timer"></span></div>
        <form id="exam-form" onsubmit="return submitExam();">
          <div id="questions-area"></div>
          <button type="submit" class="btn btn-success mt-3 btn-rounded">Submit Exam</button>
        </form>
        <div id="exam-result" class="mt-3"></div>
      </div>

      <!-- My Marks -->
      <div id="panel-marks" class="section-card" style="display:none;">
        <h4 class="mb-3">My Marks</h4>
        <div id="marks-list">Loading...</div>
      </div>
    </div>
  </div>

<script>
let currentExam = null;
let examEndTime = null;
let cheatingCount = 0;
let timerInterval = null;
let isSubmitting = false;
let serverOffsetMs = 0; // server_utc - client_now

// API helper
async function api(path, opts = {}) {
  opts.headers = opts.headers || {'Accept':'application/json'};
  if(opts.body && typeof opts.body !== 'string') {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(opts.body);
  }
  try {
    const r = await fetch(path, opts);
    return await r.json();
  } catch(e) {
    return {ok:false, error:e.message};
  }
}

// Get server time to compute offset
async function syncServerTime(){
  try{
    const res = await api('/api/server_time');
    if(res.ok && res.server_time_utc){
      const server = new Date(res.server_time_utc).getTime();
      const client = Date.now();
      serverOffsetMs = server - client;
    }
  }catch(e){ /* ignore */ }
}

// Hide all panels
function hideAll(){
  document.getElementById('panel-exams').style.display='none';
  document.getElementById('panel-exam').style.display='none';
  document.getElementById('panel-marks').style.display='none';
}

// Show exams
function showExams() {
  hideAll();
  document.getElementById('panel-exams').style.display='block';
  loadExams();
}

// Show student marks
function showMyMarks() {
  hideAll();
  document.getElementById('panel-marks').style.display='block';
  loadMarks();
}

// Load available exams
async function loadExams() {
  const el = document.getElementById('exams-list');
  el.innerHTML = 'Loading...';
  const res = await api('/api/student/exams'); // Ensure your backend route matches
  if(!res.ok){ el.innerHTML='<div class="alert alert-danger">Unable to load exams</div>'; return; }
  if(res.exams.length===0){ el.innerHTML='<div class="text-muted">No exams available currently.</div>'; return; }

  // Get student's marks to check which exams they've already taken
  const marksRes = await api('/api/student/my_marks');
  const takenExams = marksRes.ok ? marksRes.marks.map(m => m.exam_id) : [];
  console.log('Taken exams:', takenExams); // Debug log

  let html = '<ul class="list-group">';
  res.exams.forEach(e => {
    const isTaken = takenExams.includes(e.id);
    let disabled = isTaken;
    let btnLabel = isTaken ? 'Already Taken' : 'Start';
    if(e.start_at){
      const serverNow = Date.now() + serverOffsetMs;
      const startMs = new Date(e.start_at).getTime();
      if(serverNow < startMs){
        disabled = true;
        const mins = Math.max(0, Math.floor((startMs - serverNow)/60000));
        btnLabel = `Starts in ~${mins}m`;
      }
    }
    const buttonClass = disabled ? 'btn btn-sm btn-secondary disabled btn-rounded' : 'btn btn-sm btn-primary btn-rounded';
    const buttonClick = disabled ? '' : `onclick="startExam(${e.id}, '${e.title}', ${e.duration})"`;
    const status = isTaken ? '<span class="list-badge bg-success text-white">Completed</span>' : (disabled ? '<span class="list-badge bg-light text-dark">Scheduled</span>' : '<span class="list-badge bg-primary text-white">Open</span>');
    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-semibold">${e.title}</div>
        <div class="text-muted" style="font-size:12px;">Duration: ${e.duration} min ${e.start_at?` Â· Starts: ${e.start_at}`:''}</div>
      </div>
      <div class="d-flex align-items-center gap-2">
        ${status}
        <button class="${buttonClass}" ${buttonClick}>${btnLabel}</button>
      </div>
    </li>`;
  });
  html += '</ul>';
  el.innerHTML = html;
}

// Start exam
async function startExam(id, title, duration) {
  console.log('Starting exam:', id, title); // Debug log
  hideAll();
  document.getElementById('panel-exam').style.display='block';
  document.getElementById('exam-title').innerText = title;
  currentExam = id;
  cheatingCount = 0;

  // Fetch questions
  const res = await api('/api/student/exam/'+id);
  const qArea = document.getElementById('questions-area');
  if(!res.ok){
    if(res.msg==='not_started' && res.start_at){
      const serverNow = Date.now() + serverOffsetMs;
      const startMs = new Date(res.start_at).getTime();
      const waitMs = Math.max(1000, startMs - serverNow + 500); // small buffer
      qArea.innerHTML = `<div class="alert alert-warning">Exam not started yet. Starts at: ${res.start_at}${res.server_now?` (server now: ${res.server_now})`:''}. Auto starting when time reaches...</div>`;
      setTimeout(()=> startExam(id, title, duration), waitMs);
    } else {
      qArea.innerHTML='<div class="text-danger">Unable to load questions</div>';
    }
    return;
  }

  qArea.innerHTML='';
  res.exam.questions.forEach((q,idx)=>{
    qArea.innerHTML += `<div class="mb-3">
      <label><strong>Q${idx+1}: ${q.text}</strong></label>
      <div>
        <div><input type="radio" name="q${q.id}" value="A" required> A: ${q.options.A}</div>
        <div><input type="radio" name="q${q.id}" value="B"> B: ${q.options.B}</div>
        <div><input type="radio" name="q${q.id}" value="C"> C: ${q.options.C}</div>
        <div><input type="radio" name="q${q.id}" value="D"> D: ${q.options.D}</div>
      </div>
    </div>`;
  });

  // Timer
  examEndTime = Date.now() + duration*60*1000;
  updateTimer();
  timerInterval = setInterval(updateTimer, 1000);

  // Publish exam_start event
  api('/api/student/event', { method:'POST', body:{ type:'exam_start', exam_id: id, title: title }});
}

// Timer update
function updateTimer(){
  const remaining = examEndTime - Date.now();
  if(remaining <=0){
    clearInterval(timerInterval);
    submitExam();
    return;
  }
  const mins = Math.floor(remaining/60000);
  const secs = Math.floor((remaining%60000)/1000);
  document.getElementById('exam-timer').innerText = `${mins}:${secs<10?'0':''}${secs}`;
}

// Detect cheating
window.addEventListener('blur',()=>{
  if(currentExam && !isSubmitting){
    cheatingCount++;
    if(cheatingCount===1) {
      alert('Cheating detected! Your marks will be reduced by 50%. Next time, the exam will be terminated.');
      // Publish cheating event
      api('/api/student/event', { method:'POST', body:{ type:'cheating_detected', exam_id: currentExam, count: cheatingCount }});
    } else if(cheatingCount>=2) {
      alert('Cheating detected again! Exam terminated. You will receive 0 marks.');
      // Terminate the exam immediately
      clearInterval(timerInterval);
      // Publish cheating event
      api('/api/student/event', { method:'POST', body:{ type:'cheating_detected', exam_id: currentExam, count: cheatingCount }});
      submitExam();
    }
  }
});

// Submit exam
async function submitExam(){
  if(!currentExam) return false;
  isSubmitting = true; // Prevent cheating detection during submission
  clearInterval(timerInterval);

  const form = document.getElementById('exam-form');
  const formData = new FormData(form);
  const answers = {};
  for(let [key,val] of formData.entries()){ answers[key] = val; }

  console.log('DEBUG: Submitting exam with data:', {
    exam_id: currentExam, 
    answers, 
    cheating_count: cheatingCount
  });

  const res = await api('/api/student/submit_exam',{
    method:'POST',
    body:{exam_id: currentExam, answers, cheating_count: cheatingCount}
  });

  console.log('DEBUG: Submit exam response:', res);

  const resultEl = document.getElementById('exam-result');
  if(res.ok){
    let penaltyText='';
    if(res.cheating_penalty===1) penaltyText=' (50% penalty applied for cheating)';
    else if(res.cheating_penalty>=2) penaltyText=' (0 marks due to multiple cheating attempts)';
    
    let resultHtml = `<div class="alert alert-success">Exam submitted successfully!</div>`;
    resultHtml += `<div class="alert alert-info">Your final marks: ${res.total_marks}${penaltyText}</div>`;
    if(res.original_marks !== res.total_marks) {
      resultHtml += `<div class="alert alert-warning">Original score: ${res.original_marks}</div>`;
    }
    resultEl.innerHTML = resultHtml;
  } else {
    if(res.msg === 'exam_already_taken') {
      resultEl.innerHTML = `<div class="alert alert-warning">You have already taken this exam!</div>`;
    } else if(res.msg === 'not_started') {
      resultEl.innerHTML = `<div class="alert alert-warning">Exam has not started yet.</div>`;
    } else if(res.msg === 'time_over') {
      resultEl.innerHTML = `<div class="alert alert-warning">Time is over for this exam.</div>`;
    } else {
      resultEl.innerHTML = `<div class="alert alert-danger">Error submitting exam: ${res.msg || 'Unknown error'}</div>`;
    }
  }

  currentExam = null;
  showExams();
  return false;
}

// Load student marks
async function loadMarks(){
  const res = await api('/api/student/my_marks');
  const el = document.getElementById('marks-list');
  if(!res.ok){ el.innerHTML='<div class="alert alert-danger">Unable to load marks</div>'; return; }
  if(res.marks.length===0){ el.innerHTML='<div class="text-muted">No marks yet</div>'; return; }

  let html = '<div class="table-responsive"><table class="table table-sm table-bordered align-middle"><thead><tr><th>Exam</th><th style="width:140px;">Marks</th><th style="width:160px;">Cheating</th></tr></thead><tbody>';
  res.marks.forEach(m=>{
    let cheatText=m.cheating_count===0?'No': m.cheating_count===1?'Yes (50%)':'Yes (0)';
    const cheatBadge = m.cheating_count===0 ? '<span class="badge bg-success">No</span>' : (m.cheating_count===1 ? '<span class="badge bg-warning text-dark">50% Penalty</span>' : '<span class="badge bg-danger">Zero</span>');
    html += `<tr><td>${m.exam_title}</td><td>${m.marks}</td><td>${cheatBadge}</td></tr>`;
  });
  html += '</tbody></table></div>';
  el.innerHTML = html;
}

// Initialize
window.onload = async function(){
  await syncServerTime();
  showExams();
}

</script>
</body>
</html>
